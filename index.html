<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Scatterplot Graph</title>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.6.1/d3.min.js" integrity="sha512-MefNfAGJ/pEy89xLOFs3V6pYPs6AmUhXJrRlydI/9wZuGrqxmrdQ80zKHUcyadAcpH67teDZcBeS6oMJLPtTqw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
        <link rel="stylesheet" href="styles.css">
        <script src="https://kit.fontawesome.com/ba7f655f8f.js" crossorigin="anonymous"></script>
    </head>
    <body>
        <script src='https://cdn.freecodecamp.org/testable-projects-fcc/v1/bundle.js'></script>
        <script>

fetch('https://raw.githubusercontent.com/freeCodeCamp/ProjectReferenceData/master/cyclist-data.json') 
                .then(response => response.json())
                .then(response => {
                    const data = response;
                    collectedData(data)
                })

            function collectedData(data) {

                const w = 600;
                const h = 400;
                const padding = 60;

                const svg = d3.select('body')
                              .append('svg')
                              .attr('width', w)
                              .attr('height', h)

                const title = svg.append('text')
                                 .text(`Doping in Professional Bicycle Racing`)
                                 .attr('x', 180)
                                 .attr('y', 30)
                                 .attr('id', 'title')
                //x-axis
                const xAxisScale = d3.scaleLinear()
                                     .domain([d3.min(data, (d, i) => d.Year) - 1, d3.max(data, (d, i) => d.Year + 1)])
                                     .range([padding, w - padding])
                const xAxis = d3.axisBottom(xAxisScale)
                                .tickFormat(d3.format('d'))
                svg.append('g')
                   .attr('transform', 'translate(0,' + (h - padding) + ')')
                   .attr('id', 'x-axis')
                   .call(xAxis)
                //y-axis
                let specifier = "%M:%S";
                let parsedData = data.map((d) => {
                    return d3.timeParse(specifier)(d.Time);
                });
                function increasedSecond(time) {
                    let step = 1000;
                    let returnTime = [];
                    let firstTime = new Date(time[0]);
                    firstTime.setTime(time[0].getTime() - 5000)
                    let lastTime = new Date(time[1]);
                    //console.log(firstTime, time[0], lastTime)
                    for (let d = time[0]; d <= time[1]; d.setTime(d.getTime() + step)) {
                        //console.log(d.setTime(d.getTime()), d.getTime(), d)
                        if (d.getSeconds() % 15 === 0) {
                            returnTime.push(d.getTime());
                        }
                    }
                    return returnTime;
                }
                const yAxisScale = d3.scaleTime()
                                     .domain(d3.extent((parsedData)))
                                     .range([h - padding, padding])
                const yAxis = d3.axisLeft(yAxisScale)
                                .tickValues(increasedSecond(d3.extent(parsedData)))
                                .tickFormat((d) => {
                                    return d3.timeFormat(specifier)(d)
                                });
                svg.append('g')
                   .attr('transform', 'translate('+(padding)+',0)')
                   .attr('id', 'y-axis')
                   .call(yAxis)

                function xAxisMeasurements(d) {
                    let yearDifference = (d3.max(data, (d) => d.Year) - d3.min(data, (d) => d.Year)) + 2;
                    let yearGap = (d3.max(data, (d) => d.Year) + 1) - d.Year;
                    let range = w - (padding*2);
                    let result = yearGap * (range / yearDifference);
                    console.log(d3.max(data, (d) => d.Year), d3.min(data, (d) => d.Year))
                    return w - result - padding
                }
                function yAxisMeasurements(d) {
                    let secondDifference = (d3.max(data, (d) => d.Seconds) - d3.min(data, (d) => d.Seconds));
                    let secondGap = (d3.max(data, (d) => d.Seconds) + 1) - d.Seconds;
                    let range = h - (padding*2);
                    let result = secondGap * (range / secondDifference);
                    return result + padding
                }

                const circles = svg.selectAll('circle')
                                   .data(data)
                                   .enter()
                                   .append('circle')
                                   .attr('cx',(d) => xAxisMeasurements(d))
                                   .attr('cy', (d) => yAxisMeasurements(d))       
                                   .attr('r', '3')
                                   .attr('class', 'dot')
                                   .attr('data-xvalue', (d) => d.Year)
                                   .attr('data-yvalue', (d, i) => {
                                    let result = parsedData[i];
                                    return result
                                   })
            }
        </script>
    </body>
</html>